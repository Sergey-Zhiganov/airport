{% extends "base.html" %}

{% block title %}Главная - Аэропорт Подольск{% endblock %}

{% block content %}
<h2 class="mb-3">Онлайн-табло рейсов</h2>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="type" class="form-label">Тип рейса</label>
                <select class="form-select" id="type">
                    <option value="all">Все рейсы</option>
                    <option value="departures">Вылеты</option>
                    <option value="arrivals">Прибытия</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="number" class="form-label">Номер рейса</label>
                <input type="text" class="form-control" id="number" placeholder="Введите номер рейса">
            </div>
            
            <div class="col-md-3">
                <label for="airplane" class="form-label">Самолет</label>
                <input type="text" class="form-control" id="airplane" placeholder="Модель или номер самолета">
            </div>
            
            <div class="col-md-3">
                <label for="status" class="form-label">Статус</label>
                <select class="form-select" id="status">
                    <option value="">Все статусы</option>
                    {% for status in statuses %}
                        <option value="{{ status.name }}">{{ status.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="departure" class="form-label">Аэропорт вылета</label>
                <select class="form-select" id="departure">
                    <option value="">Все аэропорты</option>
                    {% for airport in airports %}
                        <option value="{{ airport.name }}">{{ airport.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="arrival" class="form-label">Аэропорт прибытия</label>
                <select class="form-select" id="arrival">
                    <option value="">Все аэропорты</option>
                    {% for airport in airports %}
                        <option value="{{ airport.name }}">{{ airport.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-6 d-flex align-items-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="resetFilters()">Сбросить фильтры</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered bg-white">
                <thead class="table-primary">
                    <tr>
                        <th>Рейс</th>
                        <th>Самолет</th>
                        <th>Направление</th>
                        <th>Вылет</th>
                        <th>Прибытие</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody id="flights-container">
                    {% for flight in flights %}
                    <tr class="flight-row" 
                        data-type="{% if flight.departure_airport.pk == 1 %}departures{% elif flight.arrival_airport.pk == 1 %}arrivals{% else %}other{% endif %}"
                        data-number="{{ flight.airplane.airline.IATA_code }} {{ flight.number }}"
                        data-airplane="{{ flight.airplane }} {{ flight.airplane.registration_number }}"
                        data-departure="{{ flight.departure_airport.name }}"
                        data-arrival="{{ flight.arrival_airport.name }}"
                        data-status="{{ flight.flight_status.name }}">
                        <td>
                            <strong>{{ flight.airplane.airline.IATA_code }} {{ flight.number }}</strong>
                        </td>
                        <td>
                            {{ flight.airplane }}<br>
                            <small class="text-muted">{{ flight.airplane.registration_number }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <strong>{{ flight.departure_airport.IATA_code }}</strong>
                                    <small class="text-muted d-block">{{ flight.departure_airport.name }}</small>
                                </div>
                                <i class="bi bi-arrow-right mx-3 text-muted"></i>
                                <div>
                                    <strong>{{ flight.arrival_airport.IATA_code }}</strong>
                                    <small class="text-muted d-block">{{ flight.arrival_airport.name }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if flight.planned_departure %}
                                {{ flight.planned_departure|date:"H:i" }}<br>
                                <small class="text-muted">{{ flight.planned_departure|date:"d.m.Y" }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if flight.planned_arrival %}
                                {{ flight.planned_arrival|date:"H:i" }}<br>
                                <small class="text-muted">{{ flight.planned_arrival|date:"d.m.Y" }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge 
                                {% if flight.flight_status.name == 'Вылетел' %}bg-success
                                {% elif flight.flight_status.name == 'Задерживается' %}bg-warning
                                {% elif flight.flight_status.name == 'Отменен' %}bg-danger
                                {% else %}bg-primary{% endif %}">
                                {{ flight.flight_status.name }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-airplane" style="font-size: 2rem;"></i><br>
                                Рейсы не найдены
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="login mt-4 text-center">
    {% if user.is_authenticated %}
        <a class="btn btn-success" href="{% url 'profile' %}">Личный кабинет</a>
    {% else %}
        <a class="btn btn-primary" href="{% url 'login' %}">Вход для сотрудников</a>
    {% endif %}
</div>

<script>
function filterFlights() {
    const typeFilter = document.getElementById('type').value;
    const numberFilter = document.getElementById('number').value.toLowerCase().trim();
    const airplaneFilter = document.getElementById('airplane').value.toLowerCase().trim();
    const departureFilter = document.getElementById('departure').value;
    const arrivalFilter = document.getElementById('arrival').value;
    const statusFilter = document.getElementById('status').value;
    
    const flightRows = document.querySelectorAll('.flight-row');
    let visibleCount = 0;
    
    flightRows.forEach(row => {
        const flightType = row.getAttribute('data-type');
        const flightNumber = row.getAttribute('data-number').toLowerCase();
        const flightAirplane = row.getAttribute('data-airplane').toLowerCase();
        const flightDeparture = row.getAttribute('data-departure');
        const flightArrival = row.getAttribute('data-arrival');
        const flightStatus = row.getAttribute('data-status');
        
        const matchesType = typeFilter === 'all' || flightType === typeFilter;
        const matchesNumber = numberFilter === '' || flightNumber.includes(numberFilter);
        const matchesAirplane = airplaneFilter === '' || flightAirplane.includes(airplaneFilter);
        const matchesDeparture = departureFilter === '' || flightDeparture === departureFilter;
        const matchesArrival = arrivalFilter === '' || flightArrival === arrivalFilter;
        const matchesStatus = statusFilter === '' || flightStatus === statusFilter;
        
        if (matchesType && matchesNumber && matchesAirplane && matchesDeparture && matchesArrival && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    const emptyRow = document.querySelector('#flights-container tr:not(.flight-row)');
    if (emptyRow) {
        if (visibleCount === 0) {
            emptyRow.style.display = '';
        } else {
            emptyRow.style.display = 'none';
        }
    }
}

function resetFilters() {
    document.getElementById('type').value = 'all';
    document.getElementById('number').value = '';
    document.getElementById('airplane').value = '';
    document.getElementById('departure').value = '';
    document.getElementById('arrival').value = '';
    document.getElementById('status').value = '';
    filterFlights();
}

document.getElementById('type').addEventListener('change', filterFlights);
document.getElementById('number').addEventListener('input', filterFlights);
document.getElementById('airplane').addEventListener('input', filterFlights);
document.getElementById('departure').addEventListener('change', filterFlights);
document.getElementById('arrival').addEventListener('change', filterFlights);
document.getElementById('status').addEventListener('change', filterFlights);

document.addEventListener('DOMContentLoaded', filterFlights);
</script>

<style>
.table th {
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.badge {
    font-size: 0.8em;
    padding: 0.5em 0.75em;
}

.flight-row {
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .card-body .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}